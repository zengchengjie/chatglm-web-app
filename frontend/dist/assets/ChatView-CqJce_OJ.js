import{r as e,j as a,k as s,i as t,E as l,c as n,b as r,l as o,d as i,t as c,w as u,f as d,m as g,F as m,n as h,p,g as v,e as y,u as f,o as w,h as k,q as L,s as _,v as C}from"./index-Dqqgi44q.js";import{_ as b,u as M}from"./_plugin-vue_export-helper-BiLrfL6K.js";const A={class:"chat-container"},I={class:"chat-header"},V={key:0,class:"user-info"},x={class:"chat-content"},H={key:0,class:"message-item assistant"},S={class:"message-role"},U={class:"message-time"},j={class:"message-content"},E=["innerHTML"],F={key:1},T={key:0,class:"stream-loading"},G={class:"chat-input-container"},K={class:"chat-input-wrapper"},q={class:"chat-options"},z=b({__name:"ChatView",setup(b){const z=M(),P=f(),Z=e(""),B=e(!0),D=e(null),J=e(null);let N=null;const O=async()=>{try{await C.confirm("确定要退出登录吗？","提示",{type:"warning"});try{await t.auth.logout()}catch(e){console.warn("Logout API call failed:",e)}localStorage.removeItem("chatglm_token"),J.value=null,z.clearChat(),P.push("/login")}catch(e){}},Q=async()=>{const e=Z.value.trim();if(e){if(!z.isLoading){Z.value="",z.addUserMessage(e),W();try{z.setLoading(!0);const a={message:e,history:z.chatHistory,stream:B.value};if(B.value){let e="";N=t.streamChat(a,a=>{e+=a,z.addAssistantMessage(e,!0),W()},()=>{z.finishStreamingMessage(),z.setLoading(!1),W(),N=null},e=>{console.error("Stream error:",e),z.setError(e.message||"流式请求失败"),z.setLoading(!1),N=null})}else{const e=await t.chat(a);z.addAssistantMessage(e),z.setLoading(!1),W()}}catch(a){console.error("Chat error:",a),z.setError(a.message||"请求失败，请稍后重试"),z.setLoading(!1)}}}else l.warning("请输入问题")},R=e=>e.replace(/ /g,"&nbsp;").replace(/\n/g,"<br>"),W=()=>{_(()=>{D.value&&(D.value.scrollTop=D.value.scrollHeight)})};return a(()=>z.messages.length,()=>{W()}),s(async()=>{try{await t.health(),console.log("Chat service is healthy"),await(async()=>{try{const e=await t.auth.getCurrentUser();J.value=e}catch(e){console.error("Failed to get current user:",e)}})()}catch(e){console.error("Failed to connect to chat service:",e),l.warning("服务连接中，请稍后再试...")}}),(e,a)=>{const s=d("el-button"),t=d("el-input"),l=d("el-checkbox"),f=d("el-alert");return w(),n("div",A,[r("div",I,[a[3]||(a[3]=r("h1",null,"ChatGLM AI助手",-1)),J.value?(w(),n("div",V,[r("span",null,"欢迎, "+c(J.value.username)+" ("+c(J.value.role)+")",1),i(s,{type:"primary",link:"",onClick:O},{default:u(()=>[...a[2]||(a[2]=[k("退出",-1)])]),_:1})])):o("",!0)]),r("div",x,[r("div",{class:"chat-messages",ref_key:"messagesContainer",ref:D},[g(z).hasMessages?o("",!0):(w(),n("div",H,[...a[4]||(a[4]=[r("div",{class:"message-role"},"AI助手",-1),r("div",{class:"message-content"}," 您好！我是ChatGLM AI助手，请问有什么可以帮助您的？ ",-1)])])),(w(!0),n(m,null,h(g(z).messages,e=>{return w(),n("div",{key:e.id,class:L(["message-item",e.role])},[r("div",S,[k(c("user"===e.role?"您":"AI助手")+" ",1),r("span",U,c(e.timestamp),1)]),r("div",j,[(s=e.content,/[a-zA-Z]/.test(s)?(w(),n("span",{key:0,innerHTML:R(e.content)},null,8,E)):(w(),n("span",F,c(e.content),1))),o("",!0)]),e.isStreaming?(w(),n("span",T,[...a[5]||(a[5]=[r("span",{class:"loading-dot"},null,-1),r("span",{class:"loading-dot"},null,-1),r("span",{class:"loading-dot"},null,-1)])])):o("",!0)],2);var s}),128))],512),r("div",G,[r("div",K,[i(t,{modelValue:Z.value,"onUpdate:modelValue":a[0]||(a[0]=e=>Z.value=e),class:"chat-input",type:"textarea",rows:3,placeholder:"请输入您的问题...",disabled:g(z).isLoading,onKeyup:v(y(Q,["ctrl"]),["enter"])},null,8,["modelValue","disabled","onKeyup"]),r("div",q,[i(l,{modelValue:B.value,"onUpdate:modelValue":a[1]||(a[1]=e=>B.value=e)},{default:u(()=>[...a[6]||(a[6]=[k("流式回复",-1)])]),_:1},8,["modelValue"])]),i(s,{type:"primary",class:"send-button",loading:g(z).isLoading,onClick:Q},{default:u(()=>[...a[7]||(a[7]=[k(" 发送 ",-1)])]),_:1},8,["loading"])]),g(z).error?(w(),p(f,{key:0,title:g(z).error,type:"error","show-icon":"",closable:!1,class:"error-alert"},null,8,["title"])):o("",!0)])])])}}},[["__scopeId","data-v-0d0511df"]]);export{z as default};
